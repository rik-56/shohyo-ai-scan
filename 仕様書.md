# 証憑 AI Scan - 仕様書

## 1. アプリケーション概要

| 項目 | 内容 |
|------|------|
| **名称** | 証憑 AI Scan (Kakeibo AI Scan) |
| **目的** | レシート・PDF・CSV等の証憑をAIで読み取り、勘定科目を編集し、Money Forward互換CSVとして出力する会計補助アプリケーション |
| **対象ユーザー** | 個人事業主、中小企業の経理担当者、会計事務所スタッフ |

---

## 2. 技術スタック

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| フレームワーク | React | ^19.2.3 |
| ビルドツール | Vite | ^6.2.0 |
| 言語 | TypeScript | ~5.8.2 |
| AI API | Google Gemini (@google/genai) | ^1.34.0 |
| UIスタイル | Tailwind CSS | CDN |
| グラフ | Recharts | ^3.6.0 |
| アイコン | Lucide React | ^0.561.0 |

---

## 3. ファイル構造

```
C:\codefolder\scan\
├── .env.local              # 環境変数（API_KEY）
├── App.tsx                 # メインアプリコンポーネント
├── index.html              # HTMLエントリー
├── index.tsx               # Reactエントリー
├── package.json            # 依存関係
├── tsconfig.json           # TypeScript設定
├── types.ts                # 型定義
├── vite.config.ts          # Vite設定
├── components/
│   ├── ScannerTab.tsx      # 証憑スキャン機能（メイン）
│   └── GeneratorTab.tsx    # 画像生成機能（補助）
├── services/
│   └── geminiService.ts    # Gemini API連携
└── scaninst/
    ├── 仕様書.md           # 本ドキュメント
    ├── インストール手順.md  # インストール手順
    ├── API設定ガイド.md    # API設定ガイド
    └── install.bat         # インストールスクリプト
```

---

## 4. 主要機能

### 4.1 ファイル読み取り機能

| 項目 | 内容 |
|------|------|
| **対応形式** | JPEG, PNG, PDF, CSV |
| **処理方式** | Base64エンコード → Gemini APIへ送信 |
| **最大ファイルサイズ** | 制限なし（API側の制限に依存） |
| **複数ファイル対応** | 可（順次処理） |
| **実装箇所** | `components/ScannerTab.tsx` |

#### 処理フロー
1. ユーザーがファイルを選択またはドラッグ&ドロップ
2. ファイルをBase64形式にエンコード
3. ファイル種別を判定（image/pdf/csv）
4. Gemini APIへ送信

### 4.2 AI解析機能

| 項目 | 内容 |
|------|------|
| **使用モデル** | gemini-3-pro-preview |
| **応答形式** | JSON |
| **実装箇所** | `services/geminiService.ts` |

#### 抽出項目

| 項目 | 形式 | 説明 |
|------|------|------|
| 取引日 | YYYY/MM/DD | 和暦対応（令和・平成等を西暦に変換） |
| 摘要 | テキスト | 取引内容の説明文 |
| 金額 | 数値 | 符号付き金額 |
| 取引種別 | income/expense | 収入/支出の区分 |

#### AIプロンプト仕様
- レシート画像から複数取引を検出
- 日付フォーマットの自動正規化
- 金額の自動抽出（税込/税抜対応）
- 店舗名・商品名から摘要を生成

### 4.3 勘定科目編集機能

| 項目 | 内容 |
|------|------|
| **編集方式** | インライン編集 |
| **デフォルト値（支出）** | 仮払金 |
| **デフォルト値（収入）** | 仮受金 |
| **学習機能** | 同一摘要への自動適用 |
| **実装箇所** | `components/ScannerTab.tsx` |

#### 学習ルール機能
- 摘要と勘定科目の組み合わせを記憶
- 同一摘要の取引に自動適用
- クライアントごとに独立して保存
- LocalStorageで永続化

### 4.4 CSV出力機能

| 項目 | 内容 |
|------|------|
| **フォーマット** | Money Forward互換 |
| **エンコード** | BOM付きUTF-8 |
| **実装箇所** | `components/ScannerTab.tsx` |

#### CSVヘッダー構成
```
取引日,借方勘定科目,借方補助科目,借方金額,貸方勘定科目,貸方補助科目,貸方金額,摘要
```

#### 出力例（支出の場合）
```csv
取引日,借方勘定科目,借方補助科目,借方金額,貸方勘定科目,貸方補助科目,貸方金額,摘要
2024/01/15,消耗品費,,1000,現金,,1000,文房具購入
```

#### 出力例（収入の場合）
```csv
取引日,借方勘定科目,借方補助科目,借方金額,貸方勘定科目,貸方補助科目,貸方金額,摘要
2024/01/15,現金,,5000,売上高,,5000,商品販売
```

### 4.5 クライアント管理機能

| 項目 | 内容 |
|------|------|
| **複数クライアント対応** | 可 |
| **学習ルール** | クライアントごとに独立 |
| **永続化** | LocalStorage |

#### 機能詳細
- クライアント（取引先）の追加・削除・切替
- クライアントごとの学習ルール保存
- クライアント一覧の永続化

### 4.6 帳簿種別機能

| 帳簿種別 | 基本科目 | 用途 |
|---------|---------|------|
| 現金出納帳 | 現金 | 現金取引の記録 |
| 預金出納帳 | 普通預金 | 銀行口座取引の記録 |
| クレジット明細 | 未払金 | クレジットカード取引の記録 |

---

## 5. データモデル

### 5.1 Transaction（取引）

```typescript
interface Transaction {
  id: string;              // 一意識別子（UUID）
  date: string;            // 取引日（YYYY/MM/DD形式）
  description: string;     // 摘要（取引内容の説明）
  amount: number;          // 金額（符号付き）
  type: 'income' | 'expense';  // 取引種別
  kamoku?: string;         // 相手勘定科目
  subKamoku?: string;      // 相手補助科目
}
```

### 5.2 HistoryBatch（取引バッチ）

```typescript
interface HistoryBatch {
  id: string;              // 一意識別子（UUID）
  timestamp: number;       // 作成日時（UNIXタイムスタンプ）
  client: string;          // クライアント名
  name: string;            // バッチ名（ファイル名等）
  transactions: Transaction[];  // 取引一覧
  totalAmount: number;     // 合計金額
  count: number;           // 取引件数
  previewUrl?: string;     // プレビュー画像URL
  fileType?: 'image' | 'pdf' | 'csv';  // ファイル種別
}
```

### 5.3 LearningRule（学習ルール）

```typescript
interface LearningRule {
  description: string;     // 摘要（キー）
  kamoku: string;          // 勘定科目
  subKamoku?: string;      // 補助科目
}
```

---

## 6. ストレージ仕様

### 6.1 LocalStorageキー

| キー | 内容 | 型 |
|------|------|-----|
| `kakeibo_ai_clients` | クライアント一覧 | `string[]` |
| `kakeibo_ai_rules_[クライアント名]` | 学習ルール | `LearningRule[]` |
| `kakeibo_ai_history` | 取引履歴 | `HistoryBatch[]` |

### 6.2 データ永続化

- すべてのデータはブラウザのLocalStorageに保存
- JSON形式でシリアライズ
- クライアント切替時に自動保存・読込

---

## 7. API仕様

### 7.1 Gemini API連携

| 項目 | 内容 |
|------|------|
| **エンドポイント** | Google Generative AI SDK経由 |
| **認証** | APIキー（環境変数） |
| **モデル** | gemini-3-pro-preview |
| **入力** | テキスト + Base64画像/PDF |
| **出力** | JSON形式の取引データ |

### 7.2 環境変数

| 変数名 | 必須 | 説明 |
|--------|------|------|
| `GEMINI_API_KEY` | ○ | Google Gemini APIキー |

---

## 8. UI仕様

### 8.1 画面構成

1. **ヘッダー**: アプリ名、クライアント選択
2. **タブ**: スキャナー / 画像生成
3. **メインエリア**: ファイルアップロード、取引一覧
4. **アクションバー**: CSV出力、履歴表示

### 8.2 操作フロー

1. クライアントを選択（または新規作成）
2. 帳簿種別を選択
3. 証憑ファイルをアップロード
4. AI解析結果を確認
5. 勘定科目を編集（必要に応じて）
6. CSV出力をダウンロード

---

## 9. エラーハンドリング

| エラー種別 | 対処 |
|-----------|------|
| APIキー未設定 | 設定画面へ誘導 |
| API呼び出し失敗 | リトライボタン表示 |
| ファイル読み取りエラー | エラーメッセージ表示 |
| 解析結果なし | 手動入力モードへ切替 |

---

## 10. セキュリティ

- APIキーは環境変数で管理（.env.local）
- .env.localは.gitignoreに追加
- クライアントサイドでのみ動作（サーバー不要）
- データはローカルストレージに保存（外部送信なし、AI解析時を除く）

---

## 11. 制限事項

- オフライン動作不可（AI解析にインターネット接続必要）
- 大量ファイルの一括処理には時間がかかる
- 手書きレシートの認識精度は低下する場合あり
- LocalStorageの容量制限（通常5MB）に注意

---

## 12. 今後の拡張予定

- [ ] 複数ファイルの一括アップロード改善
- [ ] 勘定科目マスタのインポート/エクスポート
- [ ] 他の会計ソフトフォーマット対応
- [ ] オフラインモード（OCRのみ）
- [ ] モバイル対応強化

---

## 13. バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | - | 初版リリース |

---

## 14. 問い合わせ

本アプリケーションに関するお問い合わせは、開発者までご連絡ください。
