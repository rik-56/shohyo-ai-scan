# 証憑 AI Scan - 仕様書

## 1. アプリケーション概要

| 項目 | 内容 |
|------|------|
| **名称** | 証憑 AI Scan |
| **公開URL** | https://shohyo-ai-scan.vercel.app/ |
| **目的** | レシート・PDF・CSV等の証憑をAIで読み取り、勘定科目を編集し、Money Forward互換CSVとして出力する会計補助アプリケーション |
| **対象ユーザー** | 個人事業主、中小企業の経理担当者、会計事務所スタッフ |

---

## 2. 技術スタック

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| フレームワーク | React | ^19.2.3 |
| ビルドツール | Vite | ^6.2.0 |
| 言語 | TypeScript | ~5.8.2 |
| AI API | Google Gemini API | REST API |
| UIスタイル | Tailwind CSS | CDN |
| グラフ | Recharts | ^3.6.0 |
| アイコン | Lucide React | ^0.561.0 |
| ホスティング | Vercel | - |

---

## 3. ファイル構造

```
C:\codefolder\scan\
├── App.tsx                 # メインアプリコンポーネント
├── index.html              # HTMLエントリー
├── index.tsx               # Reactエントリー
├── types.ts                # 型定義
├── package.json            # 依存関係
├── tsconfig.json           # TypeScript設定
├── vite.config.ts          # Vite設定
├── README.md               # プロジェクト説明
├── 仕様書.md               # 本ドキュメント
├── components/
│   ├── ScannerTab.tsx      # 証憑スキャン機能（メイン）
│   ├── MasterTab.tsx       # マスタ設定機能
│   ├── ManualAIModal.tsx   # 手動AI解析モーダル
│   └── Toast.tsx           # 通知コンポーネント
├── services/
│   └── geminiService.ts    # Gemini API連携
└── docs/
    ├── 使い方ガイド.md      # ユーザー向けガイド
    └── 使い方ガイド.html    # PDF変換用HTML
```

---

## 4. 主要機能

### 4.1 ファイル読み取り機能

| 項目 | 内容 |
|------|------|
| **対応形式** | JPEG, PNG, PDF, CSV |
| **処理方式** | Base64エンコード → Gemini APIへ送信 |
| **実装箇所** | `components/ScannerTab.tsx` |

### 4.2 AI解析機能

| 項目 | 内容 |
|------|------|
| **使用モデル** | Gemini 2.5 Flash（デフォルト）、選択可能 |
| **応答形式** | JSON |
| **実装箇所** | `services/geminiService.ts` |

#### 選択可能なモデル

| モデルID | 名称 | 説明 |
|----------|------|------|
| gemini-2.5-flash | Gemini 2.5 Flash | 無料・高速・安定版（推奨） |
| gemini-2.5-flash-lite | Gemini 2.5 Flash-Lite | 無料・最速 |
| gemini-2.5-pro | Gemini 2.5 Pro | 有料・高精度 |
| gemini-3-flash-preview | Gemini 3 Flash | 最新・プレビュー版 |
| gemini-3-pro-preview | Gemini 3 Pro | 最新・最高精度・プレビュー版 |
| gemini-2.0-flash | Gemini 2.0 Flash | 無料・旧世代 |

#### 抽出項目

| 項目 | 形式 | 説明 |
|------|------|------|
| 取引日 | YYYY/MM/DD | 和暦対応（令和・平成等を西暦に変換） |
| 摘要 | テキスト | 店舗名・取引内容 |
| 金額 | 数値 | 符号付き金額 |
| 取引種別 | income/expense | 収入/支出の区分 |
| インボイス区分 | 適格/非適格 | T番号の有無 |
| 税区分 | テキスト | 消費税区分 |

### 4.3 勘定科目編集機能

| 項目 | 内容 |
|------|------|
| **編集方式** | インライン編集 |
| **デフォルト値（支出）** | 仮払金 |
| **デフォルト値（収入）** | 仮受金 |
| **学習機能** | 同一摘要への自動適用 |
| **削除復活機能** | トースト通知から「元に戻す」で復活可能 |

### 4.4 CSV出力機能

| 項目 | 内容 |
|------|------|
| **フォーマット** | Money Forward互換 |
| **エンコード** | BOM付きUTF-8 |

#### CSVヘッダー構成
```
取引日,借方勘定科目,借方補助科目,借方金額,貸方勘定科目,貸方補助科目,貸方金額,摘要
```

### 4.5 マスタ設定機能

| 項目 | 内容 |
|------|------|
| **APIキー設定** | Gemini APIキーの登録・削除 |
| **モデル選択** | 使用するGeminiモデルの選択 |
| **税区分マスタ** | カスタム税区分の追加・削除 |
| **勘定科目マスタ** | クライアントごとのカスタム勘定科目 |

### 4.6 クライアント管理機能

| 項目 | 内容 |
|------|------|
| **複数クライアント対応** | 可 |
| **学習ルール** | クライアントごとに独立 |
| **永続化** | LocalStorage |

### 4.7 帳簿種別機能

| 帳簿種別 | 基本科目 | 用途 |
|---------|---------|------|
| 現金出納帳 | 現金 | 現金取引の記録 |
| 預金出納帳 | 普通預金 | 銀行口座取引の記録 |
| クレジット明細 | 未払金 | クレジットカード取引の記録 |

---

## 5. データモデル

### 5.1 Transaction（取引）

```typescript
interface Transaction {
  id: string;              // 一意識別子
  date: string;            // 取引日（YYYY/MM/DD形式）
  description: string;     // 摘要
  amount: number;          // 金額（符号付き）
  type: 'income' | 'expense';  // 取引種別
  kamoku?: string;         // 勘定科目
  subKamoku?: string;      // 補助科目
  invoiceNumber?: string;  // インボイス区分
  taxCategory?: string;    // 税区分
}
```

### 5.2 HistoryBatch（履歴バッチ）

```typescript
interface HistoryBatch {
  id: string;
  timestamp: number;
  client: string;
  name: string;
  transactions: Transaction[];
  totalAmount: number;
  count: number;
  previewUrl?: string | null;
  fileType?: 'image' | 'pdf' | 'csv';
}
```

---

## 6. ストレージ仕様

### LocalStorageキー

| キー | 内容 |
|------|------|
| `kakeibo_ai_gemini_api_key` | Gemini APIキー |
| `kakeibo_ai_gemini_model` | 選択中のGeminiモデル |
| `kakeibo_ai_custom_tax_categories` | カスタム税区分 |
| `kakeibo_ai_clients` | クライアント一覧 |
| `kakeibo_ai_accounts_[クライアント名]` | クライアント別勘定科目 |
| `kakeibo_ai_rules_[クライアント名]` | 学習ルール |
| `kakeibo_ai_history` | 取引履歴 |

---

## 7. UI仕様

### 画面構成

1. **ヘッダー**: アプリ名、タブナビゲーション
2. **スキャンタブ**: クライアント選択、帳簿設定、ファイルアップロード、取引一覧、グラフ、履歴
3. **マスタ設定タブ**: APIキー、モデル選択、税区分、勘定科目マスタ

### タブ切り替え

- 両タブを常にレンダリング（CSSで表示切替）
- タブ切り替え時もデータを保持

---

## 8. セキュリティ

- APIキーはLocalStorageに保存（ブラウザローカルのみ）
- サーバーサイドでのデータ保存なし
- データはAI解析時のみ外部送信

---

## 9. 制限事項

- オフライン動作不可（AI解析にインターネット接続必要）
- 手書きレシートの認識精度は低下する場合あり
- LocalStorageの容量制限（通常5MB）

---

## 10. バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-01 | 初版リリース |
| 1.1.0 | 2025-01 | Geminiモデル選択機能追加、削除の元に戻す機能追加、タブ切り替え時のデータ保持 |
